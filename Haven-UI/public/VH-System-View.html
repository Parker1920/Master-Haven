<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System View - Haven Galaxy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e27;
            color: #ffffff;
            overflow: hidden;
        }
        #map-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(20, 27, 61, 0.95);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(0, 194, 179, 0.3);
            max-width: 320px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 100;
        }
        #info-panel h1 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #00C2B3;
        }
        #info-panel .stat {
            margin: 6px 0;
            font-size: 13px;
        }
        #info-panel .stat span {
            color: #00C2B3;
            font-weight: bold;
        }
        #info-panel .glyph-code {
            font-family: monospace;
            font-size: 14px;
            color: #ffd93d;
            margin: 8px 0;
        }
        /* Portal Glyph Display */
        .glyph-display {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(157, 78, 221, 0.5);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
        .glyph-display-label {
            font-size: 11px;
            color: #9d4edd;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .glyph-images {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
            justify-items: center;
            margin-bottom: 8px;
        }
        .glyph-img {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            border: 1px solid rgba(157, 78, 221, 0.4);
            background: rgba(0, 0, 0, 0.5);
            object-fit: contain;
        }
        .glyph-hex {
            font-family: monospace;
            font-size: 13px;
            color: #ffd93d;
            text-align: center;
            letter-spacing: 2px;
        }
        @media (max-width: 768px) {
            .glyph-img {
                width: 28px;
                height: 28px;
            }
            .glyph-hex {
                font-size: 11px;
            }
        }
        #info-panel .description {
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            font-size: 12px;
            color: #b0b0b0;
            font-style: italic;
        }
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 27, 61, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 194, 179, 0.3);
            z-index: 100;
        }
        #controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px 12px;
            background: #00C2B3;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        #controls button:hover {
            background: #00a89a;
        }
        #object-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(20, 27, 61, 0.95);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(0, 194, 179, 0.3);
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }
        #object-info h3 {
            color: #00C2B3;
            margin-bottom: 10px;
            font-size: 18px;
        }
        #object-info p {
            margin: 5px 0;
            font-size: 13px;
        }
        #object-info .label {
            color: #9d9d9d;
        }
        #object-info .value {
            color: #ffffff;
        }
        #object-info .section-title {
            color: #ffd93d;
            font-weight: bold;
            margin-top: 12px;
            margin-bottom: 6px;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 217, 61, 0.3);
            padding-bottom: 4px;
        }
        #object-info .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }
        #object-info .info-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 6px 8px;
            border-radius: 4px;
        }
        #object-info .info-item .label {
            display: block;
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }
        #object-info .info-item .value {
            font-size: 13px;
            color: #fff;
        }
        #object-info .notes-section {
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            font-size: 12px;
            color: #b0b0b0;
        }
        .close-btn {
            float: right;
            cursor: pointer;
            color: #ff6b6b;
            font-weight: bold;
            font-size: 18px;
        }
        #tooltip {
            position: absolute;
            background: rgba(20, 27, 61, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(0, 194, 179, 0.5);
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 200;
        }
        #back-link {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
        }
        #back-to-haven {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        .discoveries-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        .discovery-item {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
        }
        .discovery-item:last-child {
            border-bottom: none;
        }
        .discovery-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 6px;
        }
        .discovery-type.flora { background: #4ade80; color: #000; }
        .discovery-type.fauna { background: #f472b6; color: #000; }
        .discovery-type.mineral { background: #fbbf24; color: #000; }
        .discovery-type.ancient { background: #a78bfa; color: #000; }
        .discovery-type.structure { background: #a78bfa; color: #000; }
        .discovery-type.creature { background: #f472b6; color: #000; }
        .discovery-type.plant { background: #4ade80; color: #000; }
        .discovery-type.resource { background: #fb923c; color: #000; }
        .discovery-type.anomaly { background: #f87171; color: #000; }
        .discovery-type.artifact { background: #c084fc; color: #000; }
        .discovery-type.waypoint { background: #60a5fa; color: #000; }
        .discovery-type.settlement { background: #34d399; color: #000; }
        .discovery-type.other { background: #94a3b8; color: #000; }

        /* Discoveries Modal */
        #discoveries-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
            padding: 20px;
        }
        #discoveries-modal.active {
            display: flex;
        }
        .discoveries-modal-content {
            background: rgba(20, 27, 61, 0.98);
            border: 1px solid rgba(0, 194, 179, 0.5);
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .discoveries-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0, 194, 179, 0.3);
            flex-shrink: 0;
        }
        .discoveries-modal-header h2 {
            color: #00C2B3;
            font-size: 20px;
            margin: 0;
        }
        .discoveries-modal-header .close-modal {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            border-radius: 4px;
            color: #ff6b6b;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        .discoveries-modal-header .close-modal:hover {
            background: #ff6b6b;
            color: #fff;
        }
        .discoveries-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .discovery-category {
            margin-bottom: 20px;
        }
        .discovery-category:last-child {
            margin-bottom: 0;
        }
        .discovery-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 217, 61, 0.3);
        }
        .discovery-category-header h3 {
            color: #ffd93d;
            font-size: 16px;
            margin: 0;
        }
        .discovery-category-count {
            background: rgba(255, 217, 61, 0.2);
            color: #ffd93d;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .discovery-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .discovery-card:last-child {
            margin-bottom: 0;
        }
        .discovery-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .discovery-card-name {
            font-weight: bold;
            color: #fff;
            font-size: 14px;
        }
        .discovery-card-details {
            font-size: 12px;
            color: #b0b0b0;
        }
        .discovery-card-details p {
            margin: 4px 0;
        }
        .discovery-card-details .detail-label {
            color: #888;
        }
        .view-discoveries-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: rgba(0, 194, 179, 0.2);
            border: 1px solid #00C2B3;
            border-radius: 6px;
            color: #00C2B3;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .view-discoveries-btn:hover {
            background: #00C2B3;
            color: #fff;
        }
        .no-discoveries {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            font-style: italic;
        }

        /* Discovery filter buttons in modal */
        .discovery-filter-bar {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(0, 194, 179, 0.2);
        }
        /* Mobile: use horizontal scroll instead of wrap to prevent overlap */
        @media (max-width: 768px) {
            .discovery-filter-bar {
                flex-wrap: nowrap;
                justify-content: flex-start;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 12px 10px;
                gap: 8px;
            }
            .discovery-filter-bar::-webkit-scrollbar {
                height: 4px;
            }
            .discovery-filter-bar::-webkit-scrollbar-thumb {
                background: rgba(0, 194, 179, 0.5);
                border-radius: 2px;
            }
        }
        .discovery-filter-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 2px solid rgba(0, 194, 179, 0.5);
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }
        .discovery-filter-btn:hover {
            background: rgba(0, 194, 179, 0.3);
            border-color: #00C2B3;
            transform: scale(1.1);
        }
        .discovery-filter-btn.active {
            background: rgba(0, 194, 179, 0.5);
            border-color: #00C2B3;
            box-shadow: 0 0 10px rgba(0, 194, 179, 0.5);
        }
        .discovery-filter-btn.empty {
            opacity: 0.3;
            filter: grayscale(100%);
        }
        .discovery-filter-btn.empty:hover {
            opacity: 0.5;
            filter: grayscale(50%);
        }
        .discovery-filter-btn .count-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            font-size: 9px;
            font-weight: bold;
            min-width: 14px;
            height: 14px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 3px;
        }
        /* Desktop: show tooltip on hover */
        @media (hover: hover) and (pointer: fine) {
            .discovery-filter-btn[title]::after {
                content: attr(title);
                position: absolute;
                bottom: -24px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(20, 27, 61, 0.95);
                color: #fff;
                padding: 3px 6px;
                border-radius: 4px;
                font-size: 9px;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s;
                z-index: 200;
            }
            .discovery-filter-btn:hover::after {
                opacity: 1;
            }
        }
        .discovery-filter-all {
            padding: 0 12px;
            width: auto;
            font-size: 11px;
            font-weight: bold;
            color: #00C2B3;
        }
        .discovery-filter-all.active {
            color: #fff;
        }

        /* Collapsible panel styles */
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .collapse-btn {
            display: none;
            background: rgba(0, 194, 179, 0.3);
            border: 1px solid #00C2B3;
            border-radius: 6px;
            padding: 6px 12px;
            color: #00C2B3;
            font-size: 11px;
            cursor: pointer;
            margin-left: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .collapse-btn:active {
            background: #00C2B3;
            color: #fff;
        }
        .collapsible-panel .panel-content {
            display: block;
            overflow: hidden;
        }
        .collapsible-panel.panel-collapsed .panel-content {
            display: none !important;
        }
        .collapsible-panel.panel-collapsed {
            padding: 10px 12px !important;
        }

        /* Mobile control buttons */
        #mobile-controls {
            display: none;
            position: absolute;
            bottom: 60px;
            right: 10px;
            z-index: 100;
        }
        #mobile-controls .control-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }
        #mobile-controls button {
            width: 44px;
            height: 44px;
            background: rgba(80, 80, 80, 0.8);
            border: 2px solid rgba(100, 100, 100, 0.6);
            border-radius: 10px;
            color: #888;
            font-size: 16px;
            cursor: pointer;
            touch-action: manipulation;
        }
        #mobile-controls button.active {
            background: rgba(0, 194, 179, 0.8);
            border-color: #00C2B3;
            color: white;
        }
        /* Mobile-friendly adjustments */
        @media (max-width: 768px) {
            #info-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                padding: 12px;
                font-size: 11px;
                max-height: 35vh;
            }
            #info-panel h1 {
                font-size: 16px;
            }
            #info-panel .stat {
                font-size: 11px;
                margin: 4px 0;
            }
            #controls {
                display: none; /* Hide desktop controls on mobile */
            }
            #mobile-controls {
                display: block;
            }
            #object-info {
                top: auto;
                bottom: 60px;
                left: 10px;
                right: 60px;
                max-width: none;
                max-height: 35vh;
                font-size: 12px;
            }
            #object-info h3 {
                font-size: 16px;
            }
            #object-info .info-grid {
                grid-template-columns: 1fr;
            }
            /* Show collapse buttons on mobile */
            .collapse-btn {
                display: inline-block;
            }
            #back-link {
                bottom: 10px !important;
                left: 10px !important;
            }
            #back-link a {
                padding: 10px 12px !important;
                font-size: 11px !important;
                gap: 6px !important;
            }
            #back-link a span {
                font-size: 14px !important;
            }
            #back-to-haven {
                bottom: 10px !important;
                right: 60px !important;
                left: 140px !important;
            }
            #back-to-haven a {
                width: 100%;
                justify-content: center;
                padding: 10px 12px !important;
                font-size: 11px !important;
                gap: 6px !important;
            }
            #back-to-haven a span {
                font-size: 14px !important;
            }
        }
    </style>
</head>
<body>
    <div id="map-container"></div>

    <div id="info-panel" class="collapsible-panel">
        <div class="panel-header">
            <h1 id="system-name">Loading...</h1>
            <button class="collapse-btn" onclick="togglePanel('info-panel')">‚ñ≤ Hide</button>
        </div>
        <div class="panel-content">
            <div class="glyph-display" id="glyph-display" style="display: none;">
                <div class="glyph-display-label">Portal Glyphs</div>
                <div class="glyph-images" id="glyph-images"></div>
                <div class="glyph-hex" id="glyph-code"></div>
            </div>
            <div class="stat">Galaxy: <span id="galaxy-name">Euclid</span></div>
            <div class="stat">Planets: <span id="planet-count">0</span></div>
            <div class="stat">Moons: <span id="moon-count">0</span></div>
            <div class="stat">Station: <span id="station-status">No</span></div>
            <div class="stat">Coords: <span id="system-coords">0, 0, 0</span></div>
            <div id="star-type-stat" class="stat" style="display: none;">Star: <span id="star-type"></span></div>
            <div id="economy-stat" class="stat" style="display: none;">Economy: <span id="economy-info"></span></div>
            <div id="conflict-stat" class="stat" style="display: none;">Conflict: <span id="conflict-level"></span></div>
            <div id="lifeform-stat" class="stat" style="display: none;">Lifeform: <span id="dominant-lifeform"></span></div>
            <div id="system-description-container" class="description" style="display: none;">
                <span id="system-description"></span>
            </div>
        </div>
    </div>

    <!-- Back to Haven Control Room Button -->
    <div id="back-to-haven">
        <a href="/" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: rgba(157, 78, 221, 0.9); border: 1px solid #9d4edd; border-radius: 8px; color: white; text-decoration: none; font-size: 14px; font-weight: bold; backdrop-filter: blur(10px); transition: all 0.2s;">
            <span style="font-size: 18px;">üè†</span> Haven Control Room
        </a>
    </div>

    <div id="controls">
        <button onclick="resetView()">Reset View</button>
        <button onclick="toggleOrbits()">Toggle Orbits</button>
        <button onclick="toggleLabels()">Toggle Labels</button>
        <button onclick="focusSun()">Focus Sun</button>
    </div>

    <!-- Mobile Control Buttons -->
    <div id="mobile-controls">
        <div class="control-row">
            <button onclick="resetView()" title="Reset View">üè†</button>
            <button id="mobile-btn-orbits" onclick="toggleOrbits(); updateMobileOrbitBtn()" title="Toggle Orbits">üîÑ</button>
            <button id="mobile-btn-labels" onclick="toggleLabels(); updateMobileLabelBtn()" title="Toggle Labels">üè∑Ô∏è</button>
            <button onclick="focusSun()" title="Focus Sun">‚òÄÔ∏è</button>
        </div>
    </div>

    <div id="object-info" class="collapsible-panel">
        <div class="panel-header">
            <h3 id="object-name"></h3>
            <button class="collapse-btn" onclick="togglePanel('object-info')">‚ñ≤ Hide</button>
            <span class="close-btn" onclick="closeObjectInfo()">&times;</span>
        </div>
        <div class="panel-content">
            <div id="object-details"></div>
        </div>
    </div>

    <div id="tooltip"></div>

    <!-- Bottom Navigation Buttons -->
    <div id="back-link">
        <a href="/map/latest" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: rgba(0, 194, 179, 0.9); border: 1px solid #00C2B3; border-radius: 8px; color: white; text-decoration: none; font-size: 14px; font-weight: bold; backdrop-filter: blur(10px); transition: all 0.2s;">
            <span style="font-size: 18px;">üåå</span> Galaxy Map
        </a>
    </div>

    <!-- Discoveries Modal -->
    <div id="discoveries-modal">
        <div class="discoveries-modal-content">
            <div class="discoveries-modal-header">
                <h2 id="discoveries-modal-title">Discoveries</h2>
                <button class="close-modal" onclick="closeDiscoveriesModal()">&times; Close</button>
            </div>
            <div class="discovery-filter-bar" id="discovery-filter-bar">
                <!-- Filter buttons will be populated by JavaScript -->
            </div>
            <div class="discoveries-modal-body" id="discoveries-modal-body">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Three.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // Data injection point - will be replaced by backend
        window.SYSTEM_DATA = null;

        // Three.js setup
        let scene, camera, renderer, controls;
        let sun, planets = [], moons = [], station = null;
        let orbitLines = [];
        let labels = [];
        let raycaster, mouse;
        let showOrbits = true;
        let showLabels = true;
        let animateOrbits = true;

        // Visual configuration
        const VISUAL_CONFIG = {
            SUN_RADIUS: 2,
            PLANET_BASE_SIZE: 0.8,
            MOON_SIZE: 0.3,
            STATION_SIZE: 0.4,
            ORBIT_SCALE: 5,
            LABEL_OFFSET: 1.5
        };

        // Colors
        const COLORS = {
            SUN: 0xffcc00,
            SUN_GLOW: 0xff9900,
            PLANET: [0x4ecdc4, 0x45b7d1, 0x96ceb4, 0xffeaa7, 0xdfe6e9, 0x74b9ff],
            MOON: 0xb2bec3,
            STATION: 0xff6b6b,
            ORBIT_LINE: 0x00C2B3
        };

        function init() {
            console.log('Initializing system view...');

            if (!window.SYSTEM_DATA) {
                document.getElementById('system-name').textContent = 'No system data';
                return;
            }

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e27);

            // Camera
            camera = new THREE.PerspectiveCamera(
                60,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 30, 50);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('map-container').appendChild(renderer.domElement);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 10;
            controls.maxDistance = 200;
            controls.target.set(0, 0, 0);

            // Raycaster
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Create scene objects
            createSun();
            createPlanets();
            createStation();
            createStarfield();

            // Update info panel
            updateInfoPanel();

            // Event listeners
            window.addEventListener('resize', onWindowResize);
            renderer.domElement.addEventListener('click', onClick);
            renderer.domElement.addEventListener('mousemove', onMouseMove);

            // Touch event listeners for mobile
            renderer.domElement.addEventListener('touchstart', onTouchStart, { passive: false });
            renderer.domElement.addEventListener('touchmove', onTouchMove, { passive: false });
            renderer.domElement.addEventListener('touchend', onTouchEnd, { passive: false });

            // Start animation
            animate();
            console.log('System view initialized');
        }

        function createSun() {
            const geometry = new THREE.SphereGeometry(VISUAL_CONFIG.SUN_RADIUS, 32, 32);
            const material = new THREE.MeshBasicMaterial({
                color: COLORS.SUN,
                transparent: true,
                opacity: 1
            });
            sun = new THREE.Mesh(geometry, material);
            sun.userData = { type: 'sun', name: 'Sun' };
            scene.add(sun);

            // Sun glow
            const glowGeometry = new THREE.SphereGeometry(VISUAL_CONFIG.SUN_RADIUS * 1.5, 32, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: COLORS.SUN_GLOW,
                transparent: true,
                opacity: 0.3
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            scene.add(glow);

            // Lights
            const light = new THREE.PointLight(0xffffff, 1, 100);
            scene.add(light);
            const ambient = new THREE.AmbientLight(0x404040);
            scene.add(ambient);
        }

        function createPlanets() {
            const systemPlanets = window.SYSTEM_DATA.planets || [];

            systemPlanets.forEach((planetData, index) => {
                const orbitRadius = (index + 1) * VISUAL_CONFIG.ORBIT_SCALE + 5;
                const angle = Math.random() * Math.PI * 2;
                const x = orbitRadius * Math.cos(angle);
                const z = orbitRadius * Math.sin(angle);
                const size = VISUAL_CONFIG.PLANET_BASE_SIZE * (0.8 + Math.random() * 0.4);

                const geometry = new THREE.SphereGeometry(size, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: COLORS.PLANET[index % COLORS.PLANET.length]
                });
                const planet = new THREE.Mesh(geometry, material);
                planet.position.set(x, 0, z);
                planet.userData = {
                    type: 'planet',
                    name: planetData.name,
                    data: planetData,
                    orbitRadius: orbitRadius,
                    orbitSpeed: 0.001 / (index + 1),
                    angle: angle
                };
                scene.add(planet);
                planets.push(planet);

                // Create orbit line
                const orbitGeometry = new THREE.BufferGeometry();
                const orbitPoints = [];
                for (let i = 0; i <= 64; i++) {
                    const a = (i / 64) * Math.PI * 2;
                    orbitPoints.push(new THREE.Vector3(
                        orbitRadius * Math.cos(a),
                        0,
                        orbitRadius * Math.sin(a)
                    ));
                }
                orbitGeometry.setFromPoints(orbitPoints);
                const orbitMaterial = new THREE.LineBasicMaterial({
                    color: COLORS.ORBIT_LINE,
                    transparent: true,
                    opacity: 0.3
                });
                const orbitLine = new THREE.Line(orbitGeometry, orbitMaterial);
                scene.add(orbitLine);
                orbitLines.push(orbitLine);

                // Create moons
                if (planetData.moons && planetData.moons.length > 0) {
                    planetData.moons.forEach((moonData, moonIndex) => {
                        const moonOrbitRadius = size + 1 + moonIndex * 0.8;
                        const moonAngle = Math.random() * Math.PI * 2;

                        const moonGeometry = new THREE.SphereGeometry(VISUAL_CONFIG.MOON_SIZE, 16, 16);
                        const moonMaterial = new THREE.MeshPhongMaterial({ color: COLORS.MOON });
                        const moon = new THREE.Mesh(moonGeometry, moonMaterial);
                        moon.userData = {
                            type: 'moon',
                            name: moonData.name,
                            data: moonData,
                            parentPlanet: planet,
                            orbitRadius: moonOrbitRadius,
                            orbitSpeed: 0.01,
                            angle: moonAngle
                        };
                        scene.add(moon);
                        moons.push(moon);
                        updateMoonPosition(moon);
                    });
                }
            });
        }

        function updateMoonPosition(moon) {
            const parent = moon.userData.parentPlanet;
            const radius = moon.userData.orbitRadius;
            const angle = moon.userData.angle;

            moon.position.set(
                parent.position.x + radius * Math.cos(angle),
                parent.position.y + radius * 0.3 * Math.sin(angle * 2),
                parent.position.z + radius * Math.sin(angle)
            );
        }

        function createStation() {
            const stationData = window.SYSTEM_DATA.space_station;
            if (!stationData) return;

            const geometry = new THREE.OctahedronGeometry(VISUAL_CONFIG.STATION_SIZE, 0);
            const material = new THREE.MeshPhongMaterial({
                color: COLORS.STATION,
                flatShading: true
            });
            station = new THREE.Mesh(geometry, material);

            const x = stationData.x || 15;
            const y = stationData.y || 5;
            const z = stationData.z || 10;
            station.position.set(x, y, z);

            station.userData = {
                type: 'station',
                name: stationData.name || 'Space Station',
                data: stationData
            };
            scene.add(station);
        }

        function createStarfield() {
            const starsGeometry = new THREE.BufferGeometry();
            const starPositions = [];

            for (let i = 0; i < 500; i++) {
                const x = (Math.random() - 0.5) * 400;
                const y = (Math.random() - 0.5) * 400;
                const z = (Math.random() - 0.5) * 400;
                starPositions.push(x, y, z);
            }

            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starPositions, 3));

            const starsMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.5,
                transparent: true,
                opacity: 0.8
            });

            const stars = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(stars);
        }

        // Glyph image filenames mapping (hex digit -> image file)
        const GLYPH_IMAGES = {
            '0': 'IMG_9202.jpg',
            '1': 'IMG_9203.jpg',
            '2': 'IMG_9204.jpg',
            '3': 'IMG_9205.jpg',
            '4': 'IMG_9206.jpg',
            '5': 'IMG_9207.jpg',
            '6': 'IMG_9208.png',
            '7': 'IMG_9209.jpg',
            '8': 'IMG_9210.jpg',
            '9': 'IMG_9211.jpg',
            'A': 'IMG_9212.jpg',
            'B': 'IMG_9213.jpg',
            'C': 'IMG_9214.jpg',
            'D': 'IMG_9215.jpg',
            'E': 'IMG_9216.jpg',
            'F': 'IMG_9217.jpg'
        };

        function updateInfoPanel() {
            const system = window.SYSTEM_DATA;

            document.getElementById('system-name').textContent = system.name || 'Unknown System';
            document.getElementById('galaxy-name').textContent = system.galaxy || 'Euclid';
            document.getElementById('planet-count').textContent = system.planets?.length || 0;

            // Render glyph display
            renderGlyphDisplay(system.glyph_code);

            let moonCount = 0;
            if (system.planets) {
                system.planets.forEach(p => {
                    moonCount += (p.moons?.length || 0);
                });
            }
            document.getElementById('moon-count').textContent = moonCount;

            document.getElementById('station-status').textContent =
                system.space_station ? 'Yes' : 'No';
            document.getElementById('system-coords').textContent =
                `${system.x || 0}, ${system.y || 0}, ${system.z || 0}`;

            // Show system description if available
            if (system.description && system.description.trim()) {
                document.getElementById('system-description').textContent = system.description;
                document.getElementById('system-description-container').style.display = 'block';
            }

            // Show system attributes if available
            if (system.star_type) {
                document.getElementById('star-type').textContent = system.star_type;
                document.getElementById('star-type-stat').style.display = 'block';
            }
            if (system.economy_type || system.economy_level) {
                let economyText = '';
                if (system.economy_type) economyText = system.economy_type;
                if (system.economy_level) economyText += (economyText ? ' (' + system.economy_level + ')' : system.economy_level);
                document.getElementById('economy-info').textContent = economyText;
                document.getElementById('economy-stat').style.display = 'block';
            }
            if (system.conflict_level) {
                document.getElementById('conflict-level').textContent = system.conflict_level;
                document.getElementById('conflict-stat').style.display = 'block';
            }
            if (system.dominant_lifeform) {
                document.getElementById('dominant-lifeform').textContent = system.dominant_lifeform;
                document.getElementById('lifeform-stat').style.display = 'block';
            }
        }

        function renderGlyphDisplay(glyphCode) {
            const displayEl = document.getElementById('glyph-display');
            const imagesEl = document.getElementById('glyph-images');
            const codeEl = document.getElementById('glyph-code');

            if (!glyphCode || glyphCode.length !== 12) {
                displayEl.style.display = 'none';
                return;
            }

            // Show the display container
            displayEl.style.display = 'block';

            // Build glyph images HTML
            let imagesHtml = '';
            for (let i = 0; i < glyphCode.length; i++) {
                const digit = glyphCode[i].toUpperCase();
                const imageFile = GLYPH_IMAGES[digit];
                if (imageFile) {
                    imagesHtml += `<img src="/haven-ui-photos/${imageFile}" alt="${digit}" class="glyph-img" title="Glyph ${digit}">`;
                } else {
                    // Fallback for unknown digit
                    imagesHtml += `<span class="glyph-img" style="display:flex;align-items:center;justify-content:center;font-size:10px;color:#9d4edd;">${digit}</span>`;
                }
            }
            imagesEl.innerHTML = imagesHtml;

            // Set formatted glyph code
            codeEl.textContent = formatGlyph(glyphCode);
        }

        function formatGlyph(glyph) {
            if (!glyph || glyph.length !== 12) return glyph;
            return `${glyph[0]}-${glyph.slice(1,4)}-${glyph.slice(4,6)}-${glyph.slice(6,9)}-${glyph.slice(9,12)}`;
        }

        function animate() {
            requestAnimationFrame(animate);

            if (animateOrbits) {
                planets.forEach(planet => {
                    planet.userData.angle += planet.userData.orbitSpeed;
                    const r = planet.userData.orbitRadius;
                    const a = planet.userData.angle;
                    planet.position.x = r * Math.cos(a);
                    planet.position.z = r * Math.sin(a);
                });

                moons.forEach(moon => {
                    moon.userData.angle += moon.userData.orbitSpeed;
                    updateMoonPosition(moon);
                });

                if (station) {
                    station.rotation.y += 0.005;
                    station.rotation.x += 0.002;
                }
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onClick(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            const objects = [sun, ...planets, ...moons];
            if (station) objects.push(station);

            const intersects = raycaster.intersectObjects(objects);

            if (intersects.length > 0) {
                const obj = intersects[0].object;
                showObjectInfo(obj.userData);
            }
        }

        function onMouseMove(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            const objects = [sun, ...planets, ...moons];
            if (station) objects.push(station);

            const intersects = raycaster.intersectObjects(objects);

            const tooltip = document.getElementById('tooltip');
            if (intersects.length > 0) {
                const obj = intersects[0].object;
                tooltip.textContent = obj.userData.name || obj.userData.type;
                tooltip.style.display = 'block';
                tooltip.style.left = (event.clientX + 15) + 'px';
                tooltip.style.top = (event.clientY + 15) + 'px';
            } else {
                tooltip.style.display = 'none';
            }
        }

        function showObjectInfo(userData) {
            const panel = document.getElementById('object-info');
            const detailsDiv = document.getElementById('object-details');

            document.getElementById('object-name').textContent = userData.name || 'Unknown';

            let html = '';
            const data = userData.data || {};

            if (userData.type === 'planet') {
                html = buildPlanetInfo(data);
            } else if (userData.type === 'moon') {
                html = buildMoonInfo(data);
            } else if (userData.type === 'station') {
                html = buildStationInfo(data);
            } else if (userData.type === 'sun') {
                html = '<p><span class="label">Type:</span> <span class="value">Star</span></p>';
                const sys = window.SYSTEM_DATA || {};
                if (sys.star_type) {
                    html += '<p><span class="label">Star Color:</span> <span class="value">' + escapeHtml(sys.star_type) + '</span></p>';
                }
                if (sys.economy_type || sys.economy_level) {
                    let economyText = sys.economy_type || '';
                    if (sys.economy_level) economyText += (economyText ? ' (' + sys.economy_level + ')' : sys.economy_level);
                    html += '<p><span class="label">Economy:</span> <span class="value">' + escapeHtml(economyText) + '</span></p>';
                }
                if (sys.conflict_level) {
                    html += '<p><span class="label">Conflict:</span> <span class="value">' + escapeHtml(sys.conflict_level) + '</span></p>';
                }
                if (sys.dominant_lifeform) {
                    html += '<p><span class="label">Dominant Lifeform:</span> <span class="value">' + escapeHtml(sys.dominant_lifeform) + '</span></p>';
                }
                if (!sys.star_type && !sys.economy_type && !sys.conflict_level && !sys.dominant_lifeform) {
                    html += '<p><span class="label">Description:</span> <span class="value">The central star of this system</span></p>';
                }
            }

            detailsDiv.innerHTML = html;
            panel.style.display = 'block';
        }

        function buildPlanetInfo(data) {
            let html = '<p><span class="label">Type:</span> <span class="value">' + (data.is_moon ? 'Moon' : 'Planet') + '</span></p>';

            // Add View 3D Planet button - opens Planet Atlas visualization
            if (data.id) {
                html += '<a href="/map/planet/' + data.id + '" target="_blank" style="display: inline-block; margin: 10px 0; padding: 10px 20px; background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%); border: 1px solid #9d4edd; border-radius: 8px; color: white; text-decoration: none; font-size: 14px; font-weight: bold; transition: all 0.2s;"' +
                        ' onmouseover="this.style.background=\'linear-gradient(135deg, #b366f9 0%, #9d4edd 100%)\'; this.style.transform=\'scale(1.02)\';"' +
                        ' onmouseout="this.style.background=\'linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%)\'; this.style.transform=\'scale(1)\';">' +
                        'üåç View 3D Planet</a>';
            }

            // Biome, Climate and Weather
            if (data.biome || data.climate || data.weather) {
                html += '<div class="section-title">Environment</div>';
                html += '<div class="info-grid">';
                if (data.biome) html += buildInfoItem('Biome', data.biome);
                if (data.climate && data.climate !== data.biome) html += buildInfoItem('Climate', data.climate);
                if (data.weather) html += buildInfoItem('Weather', data.weather);
                if (data.storm_frequency) html += buildInfoItem('Storms', data.storm_frequency);
                if (data.weather_intensity) html += buildInfoItem('Intensity', data.weather_intensity);
                html += '</div>';
            }

            // Hazards
            const hasHazards = (data.hazard_temperature && data.hazard_temperature !== 0) ||
                              (data.hazard_radiation && data.hazard_radiation !== 0) ||
                              (data.hazard_toxicity && data.hazard_toxicity !== 0);
            if (hasHazards) {
                html += '<div class="section-title">Hazards</div>';
                html += '<div class="info-grid">';
                if (data.hazard_temperature) html += buildInfoItem('Temperature', data.hazard_temperature + '¬∞');
                if (data.hazard_radiation) html += buildInfoItem('Radiation', data.hazard_radiation);
                if (data.hazard_toxicity) html += buildInfoItem('Toxicity', data.hazard_toxicity);
                html += '</div>';
            }

            // Life and Activity
            html += '<div class="section-title">Life & Activity</div>';
            html += '<div class="info-grid">';
            html += buildInfoItem('Sentinels', data.sentinel || 'N/A');
            html += buildInfoItem('Flora', data.flora || 'N/A');
            html += buildInfoItem('Fauna', data.fauna || 'N/A');
            html += buildInfoItem('Moons', (data.moons?.length || 0) + ' moon(s)');
            if (data.building_density) html += buildInfoItem('Buildings', data.building_density);
            html += '</div>';

            // Resources (individual fields or materials string)
            const hasResources = data.common_resource || data.uncommon_resource || data.rare_resource || data.materials;
            if (hasResources) {
                html += '<div class="section-title">Resources</div>';
                if (data.common_resource || data.uncommon_resource || data.rare_resource) {
                    html += '<div class="info-grid">';
                    if (data.common_resource) html += buildInfoItem('Common', data.common_resource);
                    if (data.uncommon_resource) html += buildInfoItem('Uncommon', data.uncommon_resource);
                    if (data.rare_resource) html += buildInfoItem('Rare', data.rare_resource);
                    html += '</div>';
                } else if (data.materials) {
                    html += '<p><span class="value">' + escapeHtml(data.materials) + '</span></p>';
                }
            }

            if (data.base_location) {
                html += '<div class="section-title">Base Location</div>';
                html += '<p><span class="value">' + escapeHtml(data.base_location) + '</span></p>';
            }

            if (data.notes) {
                html += '<div class="section-title">Notes</div>';
                html += '<div class="notes-section">' + escapeHtml(data.notes) + '</div>';
            }

            if (data.photo) {
                html += '<div class="section-title">Photo</div>';
                html += '<p><a href="' + getPhotoUrl(data.photo) + '" target="_blank" style="color: #00C2B3;">View Photo</a></p>';
                html += '<img src="' + getPhotoUrl(data.photo) + '" alt="' + escapeHtml(data.name) + '" style="max-width: 100%; border-radius: 8px; margin-top: 8px;">';
            }

            // Show discoveries with button to open modal
            if (data.discoveries && data.discoveries.length > 0) {
                // Store discoveries for this location in global cache
                const locationKey = 'planet_' + (data.name || 'unknown').replace(/[^a-zA-Z0-9]/g, '_');
                window._discoveryCache = window._discoveryCache || {};
                window._discoveryCache[locationKey] = { discoveries: data.discoveries, name: data.name };

                html += '<div class="section-title">Discoveries (' + data.discoveries.length + ')</div>';
                html += '<div class="discoveries-list">';
                // Show first 3 discoveries as preview
                const previewCount = Math.min(3, data.discoveries.length);
                for (let i = 0; i < previewCount; i++) {
                    const disc = data.discoveries[i];
                    const typeClass = (disc.discovery_type || '').toLowerCase().replace(/\s+/g, '');
                    html += '<div class="discovery-item">';
                    html += '<span class="discovery-type ' + typeClass + '">' + escapeHtml(disc.discovery_type || 'Unknown') + '</span>';
                    html += escapeHtml(disc.discovery_name || disc.name || 'Unnamed');
                    html += '</div>';
                }
                if (data.discoveries.length > 3) {
                    html += '<div class="discovery-item" style="color: #888; font-style: italic;">...and ' + (data.discoveries.length - 3) + ' more</div>';
                }
                html += '</div>';
                html += '<button class="view-discoveries-btn" onclick="openDiscoveriesFromCache(\'' + locationKey + '\')">View All Discoveries</button>';
            }

            return html;
        }

        function buildMoonInfo(data) {
            let html = '<p><span class="label">Type:</span> <span class="value">Moon</span></p>';

            // Add View 3D Moon button if moon has ID
            if (data.id) {
                html += '<a href="/haven-ui/planet/' + data.id + '" target="_blank" style="display: inline-block; margin: 10px 0; padding: 10px 20px; background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%); border: 1px solid #9d4edd; border-radius: 8px; color: white; text-decoration: none; font-size: 14px; font-weight: bold; transition: all 0.2s;"' +
                        ' onmouseover="this.style.background=\'linear-gradient(135deg, #b366f9 0%, #9d4edd 100%)\'; this.style.transform=\'scale(1.02)\';"' +
                        ' onmouseout="this.style.background=\'linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%)\'; this.style.transform=\'scale(1)\';">' +
                        'üåô View 3D Moon</a>';
            }

            // Biome and Weather
            if (data.biome || data.weather) {
                html += '<div class="section-title">Environment</div>';
                html += '<div class="info-grid">';
                if (data.biome) html += buildInfoItem('Biome', data.biome);
                if (data.weather) html += buildInfoItem('Weather', data.weather);
                html += '</div>';
            }

            html += '<div class="section-title">Life & Activity</div>';
            html += '<div class="info-grid">';
            html += buildInfoItem('Sentinels', data.sentinel || 'N/A');
            html += buildInfoItem('Flora', data.flora || 'N/A');
            html += buildInfoItem('Fauna', data.fauna || 'N/A');
            if (data.orbit_radius) {
                html += buildInfoItem('Orbit Radius', data.orbit_radius);
            }
            if (data.orbit_speed) {
                html += buildInfoItem('Orbit Speed', data.orbit_speed);
            }
            html += '</div>';

            if (data.materials) {
                html += '<div class="section-title">Materials</div>';
                html += '<p><span class="value">' + escapeHtml(data.materials) + '</span></p>';
            }

            if (data.notes) {
                html += '<div class="section-title">Notes</div>';
                html += '<div class="notes-section">' + escapeHtml(data.notes) + '</div>';
            }

            // Show discoveries with button to open modal
            if (data.discoveries && data.discoveries.length > 0) {
                // Store discoveries for this location in global cache
                const locationKey = 'moon_' + (data.name || 'unknown').replace(/[^a-zA-Z0-9]/g, '_');
                window._discoveryCache = window._discoveryCache || {};
                window._discoveryCache[locationKey] = { discoveries: data.discoveries, name: data.name };

                html += '<div class="section-title">Discoveries (' + data.discoveries.length + ')</div>';
                html += '<div class="discoveries-list">';
                // Show first 3 discoveries as preview
                const previewCount = Math.min(3, data.discoveries.length);
                for (let i = 0; i < previewCount; i++) {
                    const disc = data.discoveries[i];
                    const typeClass = (disc.discovery_type || '').toLowerCase().replace(/\s+/g, '');
                    html += '<div class="discovery-item">';
                    html += '<span class="discovery-type ' + typeClass + '">' + escapeHtml(disc.discovery_type || 'Unknown') + '</span>';
                    html += escapeHtml(disc.discovery_name || disc.name || 'Unnamed');
                    html += '</div>';
                }
                if (data.discoveries.length > 3) {
                    html += '<div class="discovery-item" style="color: #888; font-style: italic;">...and ' + (data.discoveries.length - 3) + ' more</div>';
                }
                html += '</div>';
                html += '<button class="view-discoveries-btn" onclick="openDiscoveriesFromCache(\'' + locationKey + '\')">View All Discoveries</button>';
            }

            return html;
        }

        function buildStationInfo(data) {
            let html = '<p><span class="label">Type:</span> <span class="value">Space Station</span></p>';

            html += '<div class="info-grid">';
            html += buildInfoItem('Race', data.race || 'Unknown');
            html += buildInfoItem('Sell Rate', (data.sell_percent || 80) + '%');
            html += buildInfoItem('Buy Rate', (data.buy_percent || 50) + '%');
            html += '</div>';

            return html;
        }

        function buildInfoItem(label, value) {
            return '<div class="info-item"><span class="label">' + escapeHtml(label) + '</span><span class="value">' + escapeHtml(String(value)) + '</span></div>';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper to normalize photo paths - handles "photos\file.jpg", "photos/file.jpg", or just "file.jpg"
        function getPhotoUrl(photo) {
            if (!photo) return null;
            if (photo.startsWith('http')) return photo;
            // Normalize backslashes to forward slashes, then extract just the filename
            const normalized = photo.replace(/\\/g, '/');
            const parts = normalized.split('/');
            const filename = parts[parts.length - 1];
            return '/haven-ui-photos/' + encodeURIComponent(filename);
        }

        function closeObjectInfo() {
            document.getElementById('object-info').style.display = 'none';
        }

        function resetView() {
            camera.position.set(0, 30, 50);
            controls.target.set(0, 0, 0);
        }

        function toggleOrbits() {
            showOrbits = !showOrbits;
            orbitLines.forEach(line => {
                line.visible = showOrbits;
            });
        }

        function toggleLabels() {
            showLabels = !showLabels;
            labels.forEach(label => {
                label.visible = showLabels;
            });
        }

        function focusSun() {
            controls.target.set(0, 0, 0);
            camera.position.set(0, 10, 20);
        }

        // Mobile button state updates
        function updateMobileOrbitBtn() {
            const btn = document.getElementById('mobile-btn-orbits');
            if (btn) {
                if (showOrbits) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }

        function updateMobileLabelBtn() {
            const btn = document.getElementById('mobile-btn-labels');
            if (btn) {
                if (showLabels) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
        }

        // ========== TOUCH CONTROLS ==========

        let touchStartTime = 0;
        let touchStartPos = { x: 0, y: 0 };
        let lastTouchPos = { x: 0, y: 0 };
        let isTouchDragging = false;
        let touchCount = 0;
        let initialPinchDistance = 0;
        let lastPinchDistance = 0;

        function onTouchStart(event) {
            touchCount = event.touches.length;
            touchStartTime = Date.now();

            if (touchCount === 1) {
                touchStartPos.x = event.touches[0].clientX;
                touchStartPos.y = event.touches[0].clientY;
                lastTouchPos.x = touchStartPos.x;
                lastTouchPos.y = touchStartPos.y;
                isTouchDragging = false;
            } else if (touchCount === 2) {
                initialPinchDistance = getPinchDistance(event.touches);
                lastPinchDistance = initialPinchDistance;
            }
        }

        function onTouchMove(event) {
            event.preventDefault();

            if (touchCount === 1 && event.touches.length === 1) {
                const touch = event.touches[0];
                const totalDeltaX = touch.clientX - touchStartPos.x;
                const totalDeltaY = touch.clientY - touchStartPos.y;
                if (Math.abs(totalDeltaX) > 10 || Math.abs(totalDeltaY) > 10) {
                    isTouchDragging = true;
                }
                lastTouchPos.x = touch.clientX;
                lastTouchPos.y = touch.clientY;
            } else if (event.touches.length === 2) {
                const currentDistance = getPinchDistance(event.touches);
                const delta = currentDistance - lastPinchDistance;

                if (Math.abs(delta) > 2) {
                    const direction = new THREE.Vector3();
                    camera.getWorldDirection(direction);
                    const moveAmount = delta > 0 ? 2 : -2;
                    camera.position.addScaledVector(direction, moveAmount);
                    lastPinchDistance = currentDistance;
                }
            }
        }

        function onTouchEnd(event) {
            const touchDuration = Date.now() - touchStartTime;

            if (touchCount === 1 && !isTouchDragging && touchDuration < 300) {
                const touch = event.changedTouches[0];
                handleTap(touch.clientX, touch.clientY);
            }

            touchCount = event.touches.length;
            if (touchCount === 0) {
                isTouchDragging = false;
            }
        }

        function getPinchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function handleTap(clientX, clientY) {
            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            const objects = [sun, ...planets, ...moons];
            if (station) objects.push(station);

            const intersects = raycaster.intersectObjects(objects);

            if (intersects.length > 0) {
                const obj = intersects[0].object;
                showObjectInfo(obj.userData);
            }
        }

        // ========== PANEL COLLAPSE TOGGLE ==========

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            if (!panel) return;

            const isCollapsed = panel.classList.contains('panel-collapsed');
            const btn = panel.querySelector('.collapse-btn');

            if (isCollapsed) {
                // Expand
                panel.classList.remove('panel-collapsed');
                if (btn) {
                    btn.textContent = '‚ñ≤ Hide';
                }
            } else {
                // Collapse
                panel.classList.add('panel-collapsed');
                if (btn) {
                    btn.textContent = '‚ñº Show';
                }
            }
        }

        // ========== DISCOVERIES MODAL ==========

        // Store current discoveries for modal
        let currentDiscoveries = [];
        let currentDiscoveryLocation = '';
        let currentFilter = 'all'; // 'all' or emoji

        // Discovery type mapping from keeper bot config
        const DISCOVERY_TYPE_MAP = {
            'ü¶¥': 'Ancient Bones & Fossils',
            'üìú': 'Text Logs & Documents',
            'üèõÔ∏è': 'Ancient Ruins',
            'üëΩ': 'Alien Structures',
            'üåø': 'Flora',
            'ü¶ó': 'Fauna',
            'üíé': 'Rare Resources',
            'üöÄ': 'Crashed Ships & Wrecks',
            '‚öôÔ∏è': 'Alien Technology & Artifacts',
            'üÜï': 'NMS Update Content',
            'üìñ': 'Player-Created Lore'
        };

        // Discovery type emojis in order
        const DISCOVERY_EMOJIS = ['ü¶¥', 'üìú', 'üèõÔ∏è', 'üëΩ', 'üåø', 'ü¶ó', 'üíé', 'üöÄ', '‚öôÔ∏è', 'üÜï', 'üìñ'];

        // Helper to match discovery types to emojis
        function matchDiscoveryType(dtype, emoji) {
            const typeMatches = {
                'ü¶¥': ['bone', 'fossil', 'skeleton', 'remains'],
                'üìú': ['text', 'log', 'document', 'message', 'record', 'tablet'],
                'üèõÔ∏è': ['ruin', 'ancient', 'temple', 'monument'],
                'üëΩ': ['alien structure', 'monolith', 'portal', 'observatory', 'facility'],
                'üåø': ['flora', 'plant', 'fern', 'tree', 'grass', 'vegetation'],
                'ü¶ó': ['fauna', 'creature', 'animal', 'species', 'predator', 'prey'],
                'üíé': ['rare', 'resource', 'crystal', 'storm crystal', 'mold', 'metal finger'],
                'üöÄ': ['crash', 'ship', 'wreck', 'vessel', 'spacecraft', 'debris'],
                '‚öôÔ∏è': ['tech', 'artifact', 'device', 'machine', 'gadget', 'technology'],
                'üÜï': ['update', 'new', 'nms', 'patch', 'content'],
                'üìñ': ['lore', 'player', 'story', 'tale', 'legend', 'history']
            };

            const keywords = typeMatches[emoji] || [];
            return keywords.some(kw => dtype.includes(kw));
        }

        // Check if a discovery matches an emoji type
        // discovery_type is stored as emoji in DB (e.g., üöÄ)
        function discoveryMatchesEmoji(disc, emoji) {
            return disc.discovery_type === emoji;
        }

        // Build the filter bar for current discoveries
        function buildFilterBar() {
            const filterBar = document.getElementById('discovery-filter-bar');
            if (!filterBar) return;

            let html = '<button class="discovery-filter-btn discovery-filter-all' +
                       (currentFilter === 'all' ? ' active' : '') +
                       '" onclick="setDiscoveryFilter(\'all\')" title="Show All">All</button>';

            DISCOVERY_EMOJIS.forEach(emoji => {
                const typeName = DISCOVERY_TYPE_MAP[emoji];
                const count = currentDiscoveries.filter(d => discoveryMatchesEmoji(d, emoji)).length;
                const isEmpty = count === 0;
                const isActive = currentFilter === emoji;

                html += '<button class="discovery-filter-btn' +
                        (isEmpty ? ' empty' : '') +
                        (isActive ? ' active' : '') +
                        '" onclick="setDiscoveryFilter(\'' + emoji + '\')" title="' + escapeHtml(typeName) + '">' + emoji;

                if (count > 0) {
                    html += '<span class="count-badge">' + count + '</span>';
                }
                html += '</button>';
            });

            filterBar.innerHTML = html;
        }

        // Set the filter and re-render discoveries
        function setDiscoveryFilter(filter) {
            currentFilter = filter;

            // Update button states
            const buttons = document.querySelectorAll('.discovery-filter-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Re-render the discoveries
            renderDiscoveries();
        }

        // Render discoveries based on current filter
        function renderDiscoveries() {
            const bodyEl = document.getElementById('discoveries-modal-body');
            const titleEl = document.getElementById('discoveries-modal-title');

            let filtered = currentDiscoveries;

            if (currentFilter !== 'all') {
                filtered = currentDiscoveries.filter(d => discoveryMatchesEmoji(d, currentFilter));
                const typeName = DISCOVERY_TYPE_MAP[currentFilter] || '';
                titleEl.textContent = currentFilter + ' ' + typeName + ' on ' + escapeHtml(currentDiscoveryLocation);
            } else {
                titleEl.textContent = 'Discoveries on ' + escapeHtml(currentDiscoveryLocation);
            }

            if (filtered.length === 0) {
                if (currentFilter !== 'all') {
                    const typeName = DISCOVERY_TYPE_MAP[currentFilter] || 'this type';
                    bodyEl.innerHTML = '<div class="no-discoveries">No ' + escapeHtml(typeName.toLowerCase()) + ' discoveries on ' + escapeHtml(currentDiscoveryLocation) + '.</div>';
                } else {
                    bodyEl.innerHTML = '<div class="no-discoveries">No discoveries recorded for this location yet.</div>';
                }
            } else {
                bodyEl.innerHTML = buildDiscoveriesModalContent(filtered);
            }
        }

        // Category display names and order - keyed by emoji (how keeper bot stores discovery_type)
        const DISCOVERY_CATEGORIES = {
            'ü¶¥': { displayName: 'Ancient Bones & Fossils', order: 1 },
            'üìú': { displayName: 'Text Logs & Documents', order: 2 },
            'üèõÔ∏è': { displayName: 'Ancient Ruins', order: 3 },
            'üëΩ': { displayName: 'Alien Structures', order: 4 },
            'üåø': { displayName: 'Flora', order: 5 },
            'ü¶ó': { displayName: 'Fauna', order: 6 },
            'üíé': { displayName: 'Rare Resources', order: 7 },
            'üöÄ': { displayName: 'Crashed Ships & Wrecks', order: 8 },
            '‚öôÔ∏è': { displayName: 'Alien Technology & Artifacts', order: 9 },
            'üÜï': { displayName: 'NMS Update Content', order: 10 },
            'üìñ': { displayName: 'Player-Created Lore', order: 11 }
        };

        function openDiscoveriesFromCache(locationKey) {
            const cached = window._discoveryCache && window._discoveryCache[locationKey];
            if (cached) {
                openDiscoveriesModal(cached.discoveries, cached.name);
            } else {
                console.warn('No discoveries found in cache for:', locationKey);
            }
        }

        function openDiscoveriesModal(discoveries, locationName) {
            currentDiscoveries = discoveries || [];
            currentDiscoveryLocation = locationName || 'Unknown Location';
            currentFilter = 'all'; // Reset filter when opening

            // Build the filter bar
            buildFilterBar();

            // Render discoveries
            renderDiscoveries();

            // Show modal
            const modal = document.getElementById('discoveries-modal');
            modal.classList.add('active');
        }

        function closeDiscoveriesModal() {
            const modal = document.getElementById('discoveries-modal');
            modal.classList.remove('active');
        }

        function buildDiscoveriesModalContent(discoveries) {
            // Group discoveries by emoji category
            const grouped = {};

            discoveries.forEach(disc => {
                // discovery_type is stored as emoji (e.g., üöÄ)
                const emoji = disc.discovery_type || '';
                const categoryInfo = DISCOVERY_CATEGORIES[emoji];

                if (categoryInfo) {
                    const key = emoji;
                    if (!grouped[key]) {
                        grouped[key] = {
                            emoji: emoji,
                            displayName: categoryInfo.displayName,
                            order: categoryInfo.order,
                            items: []
                        };
                    }
                    grouped[key].items.push(disc);
                } else {
                    // Unknown type - group under "Unknown"
                    if (!grouped['unknown']) {
                        grouped['unknown'] = {
                            emoji: '‚ùì',
                            displayName: 'Unknown Type',
                            order: 99,
                            items: []
                        };
                    }
                    grouped['unknown'].items.push(disc);
                }
            });

            // Sort categories by order
            const sortedCategories = Object.entries(grouped)
                .sort((a, b) => a[1].order - b[1].order);

            let html = '';

            sortedCategories.forEach(([key, data]) => {
                html += '<div class="discovery-category">';
                html += '<div class="discovery-category-header">';
                html += '<h3>' + data.emoji + ' ' + escapeHtml(data.displayName) + '</h3>';
                html += '<span class="discovery-category-count">' + data.items.length + '</span>';
                html += '</div>';

                data.items.forEach(disc => {
                    html += buildDiscoveryCard(disc);
                });

                html += '</div>';
            });

            return html;
        }

        function buildDiscoveryCard(disc) {
            // discovery_type is stored as emoji
            const emoji = disc.discovery_type || '';
            const categoryInfo = DISCOVERY_CATEGORIES[emoji];
            const displayType = categoryInfo ? (emoji + ' ' + categoryInfo.displayName) : (emoji || 'Unknown');

            let html = '<div class="discovery-card">';

            html += '<div class="discovery-card-header">';
            html += '<span class="discovery-type">' + escapeHtml(displayType) + '</span>';
            html += '<span class="discovery-card-name">' + escapeHtml(disc.discovery_name || disc.name || 'Unnamed Discovery') + '</span>';
            html += '</div>';

            html += '<div class="discovery-card-details">';

            if (disc.description) {
                html += '<p>' + escapeHtml(disc.description) + '</p>';
            }

            if (disc.discovered_by || disc.discord_user_id) {
                html += '<p><span class="detail-label">Discovered by:</span> ' + escapeHtml(disc.discovered_by || disc.discord_user_id) + '</p>';
            }

            if (disc.submission_timestamp) {
                const date = new Date(disc.submission_timestamp);
                const dateStr = isNaN(date.getTime()) ? disc.submission_timestamp : date.toLocaleDateString();
                html += '<p><span class="detail-label">Date:</span> ' + escapeHtml(dateStr) + '</p>';
            }

            if (disc.location_name) {
                html += '<p><span class="detail-label">Location:</span> ' + escapeHtml(disc.location_name) + '</p>';
            }

            if (disc.coordinates) {
                html += '<p><span class="detail-label">Coordinates:</span> ' + escapeHtml(disc.coordinates) + '</p>';
            }

            html += '</div>';
            html += '</div>';

            return html;
        }

        // Close modal when clicking outside
        document.getElementById('discoveries-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDiscoveriesModal();
            }
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

        if (document.readyState === 'complete') {
            init();
        }
    </script>
</body>
</html>
