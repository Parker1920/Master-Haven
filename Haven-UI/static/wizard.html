<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create System - Wizard</title>
  <link rel="stylesheet" href="/haven-ui/assets/style.css" />
  <link rel="manifest" href="/haven-ui/manifest.webmanifest">
  <meta name="theme-color" content="#00C2B3">
</head>
<body>
  <div class="app container">
    <header>
      <h1>System Entry Wizard</h1>
      <nav><a href="index.html">Back</a></nav>
    </header>
    <main>
      <div id="steps">
        <div id="step1" class="card">
          <h2>System Info</h2>
          <label>System Name</label><input id="name" />
          <label>Region</label><input id="region" />
          <label>X</label><input id="x" />
          <label>Y</label><input id="y" />
          <label>Z</label><input id="z" />
          <label>Attributes</label><input id="attributes" />
          <button id="toStep2">Next</button>
        </div>

        <div id="step2" class="card" style="display:none;">
          <h2>Planets & Moons</h2>
          <div id="planets"></div>
          <button id="addPlanet">Add Planet</button>
          <button id="saveSystem">Save</button>
        </div>
      </div>
    </main>
  </div>

<script>
  let planets = [];

  function renderPlanets(){
    const container = document.getElementById('planets');
    container.innerHTML = '';
    planets.forEach((p, idx)=>{
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<h3>Planet ${p.name || (idx+1)}</h3>
        <label>Name</label><input data-idx='${idx}' data-field='name' value='${p.name||''}'/>
        <label>Notes</label><textarea data-idx='${idx}' data-field='notes'>${p.notes||''}</textarea>
        <label>Photo</label><input type='file' data-idx='${idx}' data-file='photo' accept='image/*' />
        ${p.photo ? `<div><img src='/haven-ui-photos/${p.photo.split('/').pop()}' style='max-width:200px;max-height:120px' />` +
          `</div>` : ''}
        <div class='moons' id='moons-${idx}'></div>
        <button onclick='addMoon(${idx})'>Add Moon</button>
        <button onclick='removePlanet(${idx})'>Remove Planet</button>`;
      container.appendChild(div);
      renderMoons(idx);
    });
    // attach listeners for input changes
    const inputs = container.querySelectorAll('input,textarea');
    inputs.forEach(i=>{
      i.addEventListener('input', e=>{
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const field = e.target.getAttribute('data-field');
        planets[idx][field] = e.target.value;
      });
    });

    // attach upload listeners
    const fileInputs = container.querySelectorAll('input[type=file]');
    fileInputs.forEach(fi => {
      fi.addEventListener('change', async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const form = new FormData(); form.append('file', f);
        const r = await fetch('/api/photos', { method: 'POST', body: form });
        if (r.ok) { const j = await r.json(); planets[idx].photo = j.path; alert('Uploaded photo'); } else { alert('Upload failed'); }
      });
    });
  }

  function renderMoons(pid){
    const moonsEl = document.getElementById('moons-'+pid);
    moonsEl.innerHTML = '';
    (planets[pid].moons || []).forEach((m, midx)=>{
      const div = document.createElement('div');
      div.innerHTML = `<label>Moon Name</label><input value='${m.name||''}' data-pid='${pid}' data-mid='${midx}' data-field='name'/>
        <button onclick='removeMoon(${pid},${midx})'>Remove Moon</button>`;
      moonsEl.appendChild(div);
      div.querySelector('input').addEventListener('input', e => {
        const pid2 = parseInt(e.target.getAttribute('data-pid'));
        const midx2 = parseInt(e.target.getAttribute('data-mid'));
        const field = e.target.getAttribute('data-field');
        planets[pid2].moons[midx2][field] = e.target.value;
      });
    });
  }

  function addPlanet(){
    planets.push({name: '', notes: '', moons: []});
    renderPlanets();
  }
  function removePlanet(idx){ planets.splice(idx,1); renderPlanets(); }
  function addMoon(pid){ planets[pid].moons.push({name:''}); renderMoons(pid); }
  function removeMoon(pid, midx){ planets[pid].moons.splice(midx,1); renderMoons(pid); }

  document.getElementById('toStep2').addEventListener('click', ()=>{
    const name = document.getElementById('name').value.trim();
    if (!name){ alert('Name required'); return; }
    document.getElementById('step1').style.display='none';
    document.getElementById('step2').style.display='block';
  });

  document.getElementById('addPlanet').addEventListener('click', addPlanet);

  async function saveSystem(){
    const system = {
      name: document.getElementById('name').value.trim(),
      region: document.getElementById('region').value.trim(),
      x: parseFloat(document.getElementById('x').value),
      y: parseFloat(document.getElementById('y').value),
      z: parseFloat(document.getElementById('z').value),
      attributes: document.getElementById('attributes').value,
      planets: planets
    };
    const r = await fetch('/api/save_system', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(system) });
    if (r.ok){ alert('Saved!'); window.location.href='systems.html' } else { alert('Failed to save'); }
  }
  document.getElementById('saveSystem').addEventListener('click', saveSystem);

  // Load for editing
  function getQueryParams(){ const p={}; window.location.search.substr(1).split('&').forEach(s=>{if(s){const kv=s.split('=');p[kv[0]]=decodeURIComponent(kv[1]||'');}});return p; }
  window.onload = async ()=>{
    const q = getQueryParams();
    if (q.edit){
      const r = await fetch('/api/systems/' + q.edit);
      if (r.ok){ const s = await r.json();
        document.getElementById('name').value = s.name || '';
        document.getElementById('region').value = s.region || '';
        document.getElementById('x').value = s.x || '';
        document.getElementById('y').value = s.y || '';
        document.getElementById('z').value = s.z || '';
        document.getElementById('attributes').value = s.attributes || '';
        planets = s.planets || [];
        renderPlanets();
        // Jump to step 2
        document.getElementById('step1').style.display='none';
        document.getElementById('step2').style.display='block';
      }
    }
  }
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/haven-ui/sw.js').catch(()=>{});
  }
</script>
</body>
</html>