import{j as e}from"./vendor-three-B8lJlG1P.js";import{u as H,b as a}from"./vendor-react-D7IcbEIw.js";import{a as _}from"./vendor-ui-B9ygI19o.js";import{C as K}from"./Card-C4YgI0Ez.js";import{B as D}from"./Button-CI6OWZ-Z.js";import{A as Q}from"./index-CIVSKp76.js";import{D as X}from"./DateRangePicker-DRFStEbK.js";import{f as p}from"./parseISO-9NS-6p47.js";import"./floating-ui.dom-DAbdHeWr.js";function ne(){const j=H(),v=a.useContext(Q),[y,I]=a.useState([]),[J,k]=a.useState(!0),[f,V]=a.useState(0),[l,r]=a.useState(0),h=50,[n,S]=a.useState(""),[d,A]=a.useState(""),[c,C]=a.useState(""),[o,E]=a.useState(""),[u,L]=a.useState(""),[g,U]=a.useState(""),[i,R]=a.useState({startDate:null,endDate:null}),[W,q]=a.useState([]),[M,T]=a.useState(!1);a.useEffect(()=>{if(!v.isSuperAdmin){alert("Super admin access required"),j("/systems");return}z(),B()},[v.isSuperAdmin,j]),a.useEffect(()=>{B()},[l,n,d,c,o,u,g,i]);async function z(){try{const t=await _.get("/api/discord_tags");q(t.data.tags||[])}catch(t){console.error("Failed to load discord tags:",t)}}async function B(){k(!0);try{const t=new URLSearchParams;t.append("limit",h),t.append("offset",l*h),n&&t.append("approver",n),d&&t.append("submitter",d),c&&t.append("discord_tag",c),o&&t.append("action",o),u&&t.append("submission_type",u),g&&t.append("search",g),i.startDate&&t.append("start_date",p(i.startDate,"yyyy-MM-dd")),i.endDate&&t.append("end_date",p(i.endDate,"yyyy-MM-dd"));const s=await _.get(`/api/approval_audit?${t.toString()}`);I(s.data.entries||[]),V(s.data.total||0)}catch(t){alert("Failed to load audit log: "+(t.response?.data?.detail||t.message))}finally{k(!1)}}async function F(t){T(!0);try{const s=new URLSearchParams;s.append("format",t),n&&s.append("approver",n),d&&s.append("submitter",d),c&&s.append("discord_tag",c),o&&s.append("action",o),i.startDate&&s.append("start_date",p(i.startDate,"yyyy-MM-dd")),i.endDate&&s.append("end_date",p(i.endDate,"yyyy-MM-dd"));const m=await _.get(`/api/approval_audit/export?${s.toString()}`,{responseType:t==="csv"?"blob":"json"});if(t==="csv"){const w=new Blob([m.data],{type:"text/csv"}),b=window.URL.createObjectURL(w),x=document.createElement("a");x.href=b,x.download=`approval_audit_${p(new Date,"yyyy-MM-dd")}.csv`,x.click(),window.URL.revokeObjectURL(b)}else{const w=new Blob([JSON.stringify(m.data,null,2)],{type:"application/json"}),b=window.URL.createObjectURL(w),x=document.createElement("a");x.href=b,x.download=`approval_audit_${p(new Date,"yyyy-MM-dd")}.json`,x.click(),window.URL.revokeObjectURL(b)}}catch(s){alert("Failed to export: "+(s.response?.data?.detail||s.message))}finally{T(!1)}}function G(){S(""),A(""),C(""),E(""),L(""),U(""),R({startDate:null,endDate:null}),r(0)}function P(t){const s={approved:"bg-green-500 text-white",rejected:"bg-red-500 text-white",direct_edit:"bg-blue-500 text-white",direct_add:"bg-purple-500 text-white"},m={approved:"APPROVED",rejected:"REJECTED",direct_edit:"EDITED",direct_add:"ADDED"};return e.jsx("span",{className:`px-2 py-1 rounded text-xs font-semibold ${s[t]||"bg-gray-500 text-white"}`,children:m[t]||t.toUpperCase()})}function $(t){const s={super_admin:"bg-purple-500 text-white",partner:"bg-cyan-500 text-white",sub_admin:"bg-amber-500 text-black"},m={super_admin:"Super Admin",partner:"Partner",sub_admin:"Sub-Admin"};return e.jsx("span",{className:`px-2 py-1 rounded text-xs ${s[t]||"bg-gray-500 text-white"}`,children:m[t]||t})}const N=[n,d,c,o,u,g,i.startDate].filter(Boolean).length,O=Math.ceil(f/h);return v.isSuperAdmin?e.jsx("div",{className:"p-4 md:p-6 w-full",children:e.jsxs(K,{className:"w-full",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold",children:"Approval Audit Log"}),e.jsx("p",{className:"text-sm text-gray-400 mt-1 hidden sm:block",children:"Track all approval and rejection actions across the system."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("button",{className:"flex items-center gap-2 px-3 py-2 rounded text-sm font-medium bg-gray-700 text-white hover:bg-gray-600 transition-colors",onClick:()=>document.getElementById("export-menu").classList.toggle("hidden"),disabled:M,children:[M?e.jsx("span",{className:"animate-spin",children:"â³"}):e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),"Export"]}),e.jsxs("div",{id:"export-menu",className:"hidden absolute right-0 mt-1 w-32 bg-gray-700 rounded shadow-lg z-10",children:[e.jsx("button",{className:"w-full px-4 py-2 text-left text-sm text-white hover:bg-gray-600",onClick:()=>{document.getElementById("export-menu").classList.add("hidden"),F("csv")},children:"Export CSV"}),e.jsx("button",{className:"w-full px-4 py-2 text-left text-sm text-white hover:bg-gray-600",onClick:()=>{document.getElementById("export-menu").classList.add("hidden"),F("json")},children:"Export JSON"})]})]}),e.jsx(D,{className:"bg-gray-200 text-gray-800 text-sm",onClick:()=>j(-1),children:"Back"})]})]}),e.jsxs("div",{className:"mb-6 p-4 bg-gray-700 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-300",children:"Filters"}),N>0&&e.jsxs("button",{className:"text-xs text-cyan-400 hover:text-cyan-300 flex items-center gap-1",onClick:G,children:["Clear ",N," filter",N>1?"s":"",e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-4",children:[e.jsxs("div",{className:"sm:col-span-2 md:col-span-1",children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Date Range"}),e.jsx(X,{startDate:i.startDate,endDate:i.endDate,onChange:({startDate:t,endDate:s})=>{R({startDate:t,endDate:s}),r(0)}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Action"}),e.jsxs("select",{className:"w-full border rounded p-2 bg-gray-600 text-white text-sm",value:o,onChange:t=>{E(t.target.value),r(0)},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"direct_edit",children:"Direct Edit"}),e.jsx("option",{value:"direct_add",children:"Direct Add"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Type"}),e.jsxs("select",{className:"w-full border rounded p-2 bg-gray-600 text-white text-sm",value:u,onChange:t=>{L(t.target.value),r(0)},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{value:"system",children:"System"}),e.jsx("option",{value:"region",children:"Region"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Community"}),e.jsxs("select",{className:"w-full border rounded p-2 bg-gray-600 text-white text-sm",value:c,onChange:t=>{C(t.target.value),r(0)},children:[e.jsx("option",{value:"",children:"All"}),W.map(t=>e.jsx("option",{value:t.tag,children:t.name},t.tag))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Approver"}),e.jsx("input",{type:"text",className:"w-full border rounded p-2 bg-gray-600 text-white text-sm",placeholder:"Username...",value:n,onChange:t=>{S(t.target.value),r(0)}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Submitter"}),e.jsx("input",{type:"text",className:"w-full border rounded p-2 bg-gray-600 text-white text-sm",placeholder:"Username...",value:d,onChange:t=>{A(t.target.value),r(0)}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"Search"}),e.jsx("input",{type:"text",className:"w-full border rounded p-2 bg-gray-600 text-white text-sm",placeholder:"Notes...",value:g,onChange:t=>{U(t.target.value),r(0)}})]})]})]}),J?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500"})}):y.length===0?e.jsx("div",{className:"text-gray-400 italic p-4 bg-gray-700 rounded text-center",children:"No audit entries found matching your filters."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"md:hidden space-y-3",children:y.map(t=>e.jsxs("div",{className:"bg-gray-700 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsx("div",{className:"font-semibold",children:t.submission_name||"Unknown"}),P(t.action)]}),e.jsxs("div",{className:"text-xs text-gray-400 mb-2",children:[t.submission_type," ",t.submission_id===0?"(Direct)":`#${t.submission_id}`]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Approver"}),e.jsx("div",{className:"text-gray-200",children:t.approver_username}),e.jsx("div",{className:"mt-1",children:$(t.approver_type)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Submitter"}),e.jsx("div",{className:"text-gray-200",children:t.submitter_username||"Unknown"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Community"}),t.submission_discord_tag?e.jsx("span",{className:"px-2 py-0.5 rounded text-xs bg-cyan-600 text-white",children:t.submission_discord_tag}):e.jsx("span",{className:"text-gray-500 text-xs",children:"Untagged"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Date"}),e.jsx("div",{className:"text-gray-300 text-xs",children:new Date(t.timestamp).toLocaleDateString()})]})]}),t.notes&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-600",children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Notes"}),e.jsx("div",{className:"text-xs text-gray-300 line-clamp-2",children:t.notes})]})]},t.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm table-fixed",children:[e.jsx("thead",{className:"bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left w-[160px]",children:"Timestamp"}),e.jsx("th",{className:"px-4 py-3 text-left w-[100px]",children:"Action"}),e.jsx("th",{className:"px-4 py-3 text-left w-[200px]",children:"Submission"}),e.jsx("th",{className:"px-4 py-3 text-left w-[160px]",children:"Approver"}),e.jsx("th",{className:"px-4 py-3 text-left w-[140px]",children:"Submitter"}),e.jsx("th",{className:"px-4 py-3 text-left w-[120px]",children:"Community"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Notes"})]})}),e.jsx("tbody",{children:y.map(t=>e.jsxs("tr",{className:"border-b border-gray-600 hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-3 text-gray-300 whitespace-nowrap",children:new Date(t.timestamp).toLocaleString()}),e.jsx("td",{className:"px-4 py-3",children:P(t.action)}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-semibold truncate",title:t.submission_name||"Unknown",children:t.submission_name||"Unknown"}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[t.submission_type," ",t.submission_id===0?"(Direct)":`#${t.submission_id}`]})]}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-semibold truncate",title:t.approver_username,children:t.approver_username}),e.jsx("div",{className:"mt-1",children:$(t.approver_type)})]}),e.jsxs("td",{className:"px-4 py-3 text-gray-300",children:[e.jsx("div",{className:"truncate",title:t.submitter_username||"Unknown",children:t.submitter_username||"Unknown"}),t.submitter_type&&e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:t.submitter_type})]}),e.jsx("td",{className:"px-4 py-3",children:t.submission_discord_tag?e.jsx("span",{className:"px-2 py-1 rounded text-xs bg-cyan-600 text-white",children:t.submission_discord_tag}):e.jsx("span",{className:"text-gray-500 text-xs",children:"Untagged"})}),e.jsx("td",{className:"px-4 py-3 text-gray-300 text-sm",children:t.notes?e.jsx("span",{className:"block truncate",title:t.notes,children:t.notes}):e.jsx("span",{className:"text-gray-500",children:"-"})})]},t.id))})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mt-6 pt-4 border-t border-gray-600",children:[e.jsxs("p",{className:"text-xs sm:text-sm text-gray-400 text-center sm:text-left",children:[l*h+1,"-",Math.min((l+1)*h,f)," of ",f]}),e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx(D,{className:"bg-gray-600 text-white text-sm px-3 py-1",onClick:()=>r(t=>Math.max(0,t-1)),disabled:l===0,children:"Prev"}),e.jsxs("span",{className:"text-sm text-gray-400 flex items-center px-2",children:[l+1,"/",O||1]}),e.jsx(D,{className:"bg-gray-600 text-white text-sm px-3 py-1",onClick:()=>r(t=>t+1),disabled:l>=O-1,children:"Next"})]})]})]})]})}):null}export{ne as default};
